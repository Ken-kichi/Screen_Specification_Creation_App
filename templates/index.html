{% extends 'base.html' %}

{% block title %}
画面設計書作成アプリ
{% endblock %}

{% block page_title %}
画面設計書作成アプリ
{% endblock %}

{% block contents %}
<form method="post" enctype="multipart/form-data" hx-post="/" hx-target="#specification" hx-swap="innerHTML"
    class="form-inline">

    <input type="file" name="file" accept="image/*" required onchange="previewFile(this);"
        class="form-control my-2 mr-sm-2">
    <button type="submit" class="btn btn-primary mb-2">アップロード</button>
    <div class="alert alert-success mt-2">
        <h3>▼プレビュー</h3>
        <img id="preview" class="img-fluid mb-3">
    </div>
</form>
<div id="specification" class="mt-3">
    {% if specification %}
    <h2 class="text-center">画面仕様書作成アプリ</h2>
    <button type="button" class="btn btn-primary my-2" onclick="onDownloadCSV()">CSVを出力する</button>
    <pre id="getted_csv"> {{ specification }}</pre>
    {% endif %}
</div>

<script>
    function previewFile(img) {
        const fileData = new FileReader();
        fileData.onload = (function () {
            document.getElementById('preview').src = fileData.result;
        });
        fileData.readAsDataURL(img.files[0]);
    }

    function onDownloadCSV() {
        const today = new Date();
        const options = { timeZone: 'Asia/Tokyo', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const formatter = new Intl.DateTimeFormat('ja-JP', options);
        const formattedDate = formatter.format(today).replace(/\//g, '-').replace(/, /g, '_').replace(/ /g, '_');
        const filename = `${formattedDate}_screen_design_document.csv`;
        //prettier-ignore
        const csvText = document.getElementById("getted_csv").textContent;
        const blob = new Blob([csvText], { type: "text/csv" });

        const link = document.createElement('a')
        link.download = filename
        link.href = URL.createObjectURL(blob)
        link.click()

    }
</script>
{% endblock %}
